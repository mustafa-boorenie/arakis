# Arakis Deployment Guide

Complete guide for deploying Arakis to a production VM.

## Prerequisites

- Ubuntu 22.04 LTS server
- Domain name pointed to your server's IP
- Root or sudo access
- Email address for SSL certificates

## Quick Start

### 1. Run Setup Script

```bash
# SSH into your server
ssh user@your-server-ip

# Download setup script
wget https://raw.githubusercontent.com/yourusername/arakis/main/deploy/setup_vm.sh

# Run setup (replace with your domain and email)
sudo bash setup_vm.sh arakis.example.com admin@example.com
```

The script will:
- ✅ Install Docker and Docker Compose
- ✅ Install and configure Nginx
- ✅ Setup UFW firewall
- ✅ Install Certbot for SSL
- ✅ Clone the repository
- ✅ Configure systemd service
- ✅ Setup automated backups
- ✅ Apply system optimizations

### 2. Configure Environment

```bash
# Edit environment file
sudo nano /opt/arakis/.env

# Required settings:
OPENAI_API_KEY=sk-your-key-here
UNPAYWALL_EMAIL=your.email@example.com

# Generated automatically (secure defaults):
SECRET_KEY=<auto-generated>
POSTGRES_PASSWORD=<auto-generated>
DATABASE_URL=postgresql+asyncpg://arakis:<password>@postgres:5432/arakis
DEBUG=false
```

### 3. Start Services

```bash
# Start Arakis
sudo systemctl start arakis

# Check status
sudo systemctl status arakis

# View logs
sudo journalctl -u arakis -f
```

### 4. Initialize Database

```bash
cd /opt/arakis

# Run migrations
docker compose exec api alembic upgrade head

# Verify database
docker compose exec postgres psql -U arakis -d arakis -c "\dt"
```

### 5. Verify Deployment

```bash
# Check all containers
docker ps

# Test API
curl https://arakis.example.com/health

# View API docs
open https://arakis.example.com/docs
```

## Manual Deployment (Advanced)

If you prefer manual setup or need to customize the deployment:

### 1. Install Docker

```bash
# Add Docker's GPG key
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
sudo chmod a+r /etc/apt/keyrings/docker.gpg

# Add repository
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# Install
sudo apt-get update
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

### 2. Install Nginx

```bash
sudo apt-get install nginx
sudo systemctl enable nginx
sudo systemctl start nginx
```

### 3. Configure Firewall

```bash
sudo ufw allow ssh
sudo ufw allow http
sudo ufw allow https
sudo ufw enable
```

### 4. Clone Repository

```bash
sudo mkdir -p /opt/arakis
cd /opt/arakis
sudo git clone https://github.com/yourusername/arakis.git .
```

### 5. Configure Environment

```bash
sudo cp .env.example .env
sudo nano .env

# Generate secure keys
openssl rand -hex 32  # Use for SECRET_KEY
openssl rand -base64 32 | tr -d "=+/" | cut -c1-32  # Use for POSTGRES_PASSWORD
```

### 6. Setup Nginx

```bash
# Copy configuration
sudo cp deploy/nginx.conf /etc/nginx/sites-available/arakis

# Update domain
sudo sed -i 's/your-domain.com/arakis.example.com/g' /etc/nginx/sites-available/arakis

# Enable site
sudo ln -s /etc/nginx/sites-available/arakis /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default

# Test and reload
sudo nginx -t
sudo systemctl reload nginx
```

### 7. Setup SSL

```bash
sudo apt-get install certbot python3-certbot-nginx

# Obtain certificate
sudo certbot --nginx -d arakis.example.com --non-interactive --agree-tos --email admin@example.com

# Enable auto-renewal
sudo systemctl enable certbot.timer
```

### 8. Setup Systemd Service

```bash
# Copy service file
sudo cp deploy/arakis.service /etc/systemd/system/

# Update paths if needed
sudo sed -i 's|/opt/arakis|/your/custom/path|g' /etc/systemd/system/arakis.service

# Enable and start
sudo systemctl daemon-reload
sudo systemctl enable arakis
sudo systemctl start arakis
```

### 9. Setup Backups

```bash
# Make script executable
sudo chmod +x /opt/arakis/deploy/backup.sh

# Add cron job (daily at 2 AM)
echo "0 2 * * * /opt/arakis/deploy/backup.sh >> /var/log/arakis-backup.log 2>&1" | sudo crontab -
```

## Production Configuration

The deployment uses `docker-compose.yml` + `docker-compose.prod.yml` for production settings:

```bash
# Production settings include:
- Resource limits (2 CPU, 2GB RAM for API)
- No development volume mounts
- Log rotation (10MB files, 3-5 retained)
- Optimized PostgreSQL settings
- Redis memory limits with LRU eviction
- Restart policies for all services
```

## Maintenance

### Update Application

```bash
cd /opt/arakis
sudo git pull origin main
sudo systemctl restart arakis
```

### View Logs

```bash
# System service logs
sudo journalctl -u arakis -f

# Container logs
docker logs -f arakis-api
docker logs -f arakis-postgres
docker logs -f arakis-redis

# Nginx logs
sudo tail -f /var/log/nginx/arakis_access.log
sudo tail -f /var/log/nginx/arakis_error.log
```

### Database Backup

```bash
# Manual backup
sudo /opt/arakis/deploy/backup.sh

# Backup with S3 upload
sudo /opt/arakis/deploy/backup.sh --upload-s3

# Custom retention
sudo /opt/arakis/deploy/backup.sh --retention-days 60

# View backups
ls -lh /var/backups/arakis/
```

### Database Restore

```bash
# Stop API
sudo systemctl stop arakis

# Restore from backup
gunzip -c /var/backups/arakis/arakis_backup_YYYYMMDD_HHMMSS.sql.gz | \
  docker compose exec -T postgres psql -U arakis -d arakis

# Start API
sudo systemctl start arakis
```

### Restart Services

```bash
# Restart all
sudo systemctl restart arakis

# Restart single service
docker compose restart api
docker compose restart postgres
docker compose restart redis
```

### Monitor Resources

```bash
# Docker stats
docker stats

# System resources
htop

# Disk usage
df -h
docker system df
```

## Troubleshooting

### API Won't Start

```bash
# Check logs
sudo journalctl -u arakis -n 100

# Check Docker
docker ps -a
docker logs arakis-api

# Verify environment
docker compose exec api env | grep DATABASE_URL
```

### Database Connection Issues

```bash
# Check PostgreSQL
docker compose exec postgres pg_isready -U arakis

# Test connection
docker compose exec postgres psql -U arakis -d arakis -c "SELECT 1;"

# Check network
docker network inspect arakis_arakis-network
```

### SSL Certificate Issues

```bash
# Test renewal
sudo certbot renew --dry-run

# Renew manually
sudo certbot renew

# Check certificate
sudo certbot certificates
```

### Nginx Issues

```bash
# Test configuration
sudo nginx -t

# Reload
sudo systemctl reload nginx

# Check status
sudo systemctl status nginx
```

### Out of Disk Space

```bash
# Clean Docker
docker system prune -a --volumes

# Clean old logs
sudo journalctl --vacuum-time=7d

# Clean old backups
find /var/backups/arakis -name "*.sql.gz" -mtime +30 -delete
```

### High Memory Usage

```bash
# Check Docker memory
docker stats --no-stream

# Adjust resource limits in docker-compose.prod.yml
# Then restart:
sudo systemctl restart arakis
```

## Security Hardening

### 1. SSH Hardening

```bash
# Disable root login
sudo sed -i 's/PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config

# Disable password auth (use keys only)
sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config

# Restart SSH
sudo systemctl restart sshd
```

### 2. Enable Fail2Ban

```bash
sudo apt-get install fail2ban
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

### 3. Auto Security Updates

```bash
sudo apt-get install unattended-upgrades
sudo dpkg-reconfigure -plow unattended-upgrades
```

### 4. Database Security

```bash
# Ensure .env has strong passwords
# File permissions
sudo chmod 600 /opt/arakis/.env
sudo chown root:root /opt/arakis/.env

# Network isolation (containers can't reach host)
# Already configured in docker-compose.yml
```

### 5. Rate Limiting

Rate limiting is configured in nginx.conf:
- API endpoints: 10 req/s
- Auth endpoints: 5 req/min

## Monitoring

### Health Checks

```bash
# API health
curl https://arakis.example.com/health

# Database health
docker compose exec postgres pg_isready

# Redis health
docker compose exec redis redis-cli ping
```

### Setup Monitoring (Optional)

Consider adding:
- **Prometheus + Grafana** for metrics
- **Loki** for log aggregation
- **Uptime Kuma** for uptime monitoring
- **Sentry** for error tracking

## Performance Optimization

### 1. Database Tuning

Already configured in `docker-compose.prod.yml`:
- `shared_buffers=256MB`
- `max_connections=200`

For more traffic, edit PostgreSQL settings:

```bash
# Edit postgres command in docker-compose.prod.yml
shared_buffers=512MB
effective_cache_size=1536MB
maintenance_work_mem=128MB
```

### 2. Redis Optimization

Already configured with:
- Memory limit: 512MB
- LRU eviction policy
- AOF persistence

### 3. Nginx Caching (Optional)

Add to nginx.conf:

```nginx
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=api_cache:10m max_size=1g inactive=60m;

location /api/ {
    proxy_cache api_cache;
    proxy_cache_valid 200 5m;
}
```

## Scaling

### Horizontal Scaling

To scale API servers:

```bash
# Scale API to 3 instances
docker compose up -d --scale api=3

# Update nginx to load balance
# Add upstream servers to nginx.conf
```

### Vertical Scaling

Increase resources in `docker-compose.prod.yml`:

```yaml
deploy:
  resources:
    limits:
      cpus: '4'
      memory: 4G
```

## Backup Strategy

### Automated Backups

- **Frequency**: Daily at 2 AM (cron)
- **Retention**: 30 days (configurable)
- **Location**: `/var/backups/arakis/`
- **Optional**: S3 upload for off-site backup

### Manual Backup Before Updates

```bash
# Always backup before updates
sudo /opt/arakis/deploy/backup.sh

# Then update
cd /opt/arakis
sudo git pull origin main
sudo systemctl restart arakis
```

## Support

- **Documentation**: https://github.com/yourusername/arakis
- **Issues**: https://github.com/yourusername/arakis/issues
- **API Docs**: https://arakis.example.com/docs

## Files Reference

| File | Location | Purpose |
|------|----------|---------|
| Application | `/opt/arakis/` | Main installation |
| Environment | `/opt/arakis/.env` | Configuration |
| Systemd Service | `/etc/systemd/system/arakis.service` | Service management |
| Nginx Config | `/etc/nginx/sites-available/arakis` | Reverse proxy |
| SSL Certificates | `/etc/letsencrypt/live/<domain>/` | TLS certificates |
| Backups | `/var/backups/arakis/` | Database backups |
| Logs (System) | `journalctl -u arakis` | Service logs |
| Logs (Nginx) | `/var/log/nginx/arakis_*.log` | Web server logs |
| Logs (Docker) | `docker logs <container>` | Container logs |

## Next Steps

After deployment:

1. ✅ Test API endpoints
2. ✅ Create first workflow via API
3. ✅ Monitor logs for errors
4. ✅ Setup monitoring (optional)
5. ✅ Configure backups to S3 (optional)
6. ✅ Setup CI/CD (Phase 5)
