# Cost Optimization Implementation Progress

**Start Date:** 2026-01-29
**Status:** Planning Complete, Ready for Implementation

---

## Phase 1: Foundation ⏳ NOT STARTED

### 1.1 Database Migration
- [ ] Create Alembic migration for `workflows.cost_mode` column
- [ ] Migration tested (upgrade/downgrade)
- [ ] **Files:** `alembic/versions/`

### 1.2 Cost Mode Configuration System
- [ ] Create `src/arakis/config/cost_modes.py`
  - [ ] `CostMode` enum (QUALITY, BALANCED, FAST, ECONOMY)
  - [ ] `ModeConfig` dataclass
  - [ ] Default mode mapping
- [ ] Unit tests for configuration loading
- [ ] **Files:** `src/arakis/config/cost_modes.py`, `tests/unit/config/`

### 1.3 Dynamic Model Configuration
- [ ] Update `src/arakis/agents/models.py`
  - [ ] Function to get models for current mode
  - [ ] Fallback chain logic
- [ ] Unit tests for model selection
- [ ] **Files:** `src/arakis/agents/models.py`, `tests/unit/agents/`

---

## Phase 2: Agent Integration ⏳ NOT STARTED

### 2.1 Screening Agent
- [ ] Update `ScreeningAgent` to read mode config
  - [ ] `dual_review` parameter from mode
  - [ ] Model selection from mode
- [ ] Unit tests for each mode
- [ ] **Files:** `src/arakis/agents/screener.py`

### 2.2 Extraction Agent
- [ ] Update `DataExtractionAgent` to read mode config
  - [ ] `triple_review` parameter from mode
  - [ ] `use_full_text` parameter from mode
  - [ ] Model selection from mode
- [ ] Unit tests for each mode
- [ ] **Files:** `src/arakis/agents/extractor.py`

### 2.3 Writing Agents
- [ ] Update `IntroductionWriter` model selection
- [ ] Update `MethodsWriter` model selection
- [ ] Update `ResultsWriter` model selection
- [ ] Update `DiscussionWriter` model selection
- [ ] Update `AbstractWriter` model selection
- [ ] Unit tests for model selection
- [ ] **Files:** `src/arakis/agents/*_writer.py`

---

## Phase 3: Orchestrator Integration ⏳ NOT STARTED

### 3.1 Workflow Model
- [ ] Add `cost_mode` field to Workflow model
- [ ] Update Pydantic schemas
- [ ] **Files:** `src/arakis/database/models.py`, `src/arakis/schemas/workflow.py`

### 3.2 Workflow Creation API
- [ ] Accept `cost_mode` in workflow creation endpoint
- [ ] Validate mode value
- [ ] Store in database
- [ ] Unit tests
- [ ] **Files:** `src/arakis/api/routes/workflows.py`

### 3.3 Orchestrator
- [ ] Pass mode to all stage executors
- [ ] Load mode from workflow record
- [ ] Unit tests
- [ ] **Files:** `src/arakis/workflow/orchestrator.py`

### 3.4 Stage Executors ✅ COMPLETE
- [x] Update `ScreenStageExecutor` to use mode
- [x] Update `ExtractStageExecutor` to use mode
- [x] Update `BaseStageExecutor` to accept mode_config
- [x] **Files:** `src/arakis/workflow/stages/*.py`

### 3.5 Orchestrator Updates ✅ COMPLETE
- [x] Load cost_mode from workflow
- [x] Create mode_config
- [x] Pass mode_config to stage executors
- [x] Handle stage skipping (RoB, Analysis) based on mode
- [x] **Files:** `src/arakis/workflow/orchestrator.py`

---

## Phase 4: Settings UI (Optional) ⏳ NOT STARTED

### 4.1 Backend Settings
- [ ] Add default mode to settings/config
- [ ] Endpoint to get/set default mode
- [ ] **Files:** `src/arakis/config.py`, `src/arakis/api/routes/settings.py`

### 4.2 Frontend Settings Page
- [ ] Add mode selector dropdown
- [ ] Show mode descriptions
- [ ] Save preference
- [ ] **Files:** `frontend/src/pages/settings/`

### 4.3 Workflow Display
- [ ] Show mode in workflow details
- [ ] Show estimated/actual cost
- [ ] **Files:** `frontend/src/pages/workflows/`

---

## Phase 5: PRISMA Programmatic (REQUIRED) ✅ COMPLETE

### 5.1 Research ✅
- [x] Analyzed https://estech.shinyapps.io/prisma_flowdiagram/
- [x] Documented PRISMA 2020 flow structure
- [x] Verified existing data structure (PRISMAFlow model)

### 5.2 SVG Generator ✅
- [x] Added SVG generation to `src/arakis/visualization/prisma.py`
- [x] Implemented 2020 PRISMA flow diagram as SVG
- [x] Handles all count types (records, reports, studies)
- [x] Unit tests with various scenarios (14 tests, all passing)

### 5.3 Integration ✅
- [x] Verified: No LLM PRISMA code exists to remove (already programmatic)
- [x] Updated PRISMA stage executor to use SVG as primary format
- [x] Stage reports `cost=0.0` (no LLM cost)

**Key Changes:**
1. `src/arakis/visualization/prisma.py` - Added `_generate_svg_content()` method
2. `src/arakis/workflow/stages/prisma.py` - Updated to use SVG format
3. `tests/unit/visualization/test_prisma.py` - 14 unit tests

**Status:** PRISMA is now ALWAYS programmatic SVG in ALL modes. ✅

---

## Testing Checklist

### Unit Tests Required
- [ ] Configuration loading (all modes)
- [ ] Model selection for each mode
- [ ] Agent flag settings (dual_review, triple_review, use_full_text)
- [ ] Cost calculation accuracy
- [ ] Workflow mode storage/retrieval

### Integration Tests Required
- [ ] Full pipeline with each mode (mocked APIs)
- [ ] API endpoint workflow creation with mode
- [ ] PRISMA generator with various counts

### Manual QA Required
- [ ] Run QUALITY mode end-to-end
- [ ] Run BALANCED mode end-to-end
- [ ] Compare outputs for quality
- [ ] Verify cost savings

---

## Cost Verification Plan

After implementation, run identical reviews with each mode:

| Mode | Expected Cost | Actual Cost | Variance |
|------|---------------|-------------|----------|
| QUALITY | ~$15 | TBD | TBD |
| BALANCED | ~$4 | TBD | TBD |
| FAST | ~$1.50 | TBD | TBD |
| ECONOMY | ~$0.80 | TBD | TBD |

---

## Blockers
None currently identified.

---

## Notes
## DECISIONS CONFIRMED
1. ✅ FAST mode skips RoB and Analysis stages for speed
2. ✅ Default mode: BALANCED
3. ✅ Cost tracking: Final cost only (at completion)
4. ✅ **PRISMA is ALWAYS programmatic SVG - NEVER LLM in any mode**

## MODEL SELECTION FINAL
- **QUALITY:** gpt-5-mini (dual/triple) + gpt-5.2-2025-12-11 (max reasoning)
- **BALANCED/FAST/ECONOMY:** gpt-5-nano (single) + o3-mini

## STAGE SKIPPING
- **QUALITY:** All 12 stages, PRISMA programmatic
- **BALANCED:** All 12 stages (cheaper models), PRISMA programmatic
- **FAST:** Skips RoB + Analysis, PRISMA programmatic
- **ECONOMY:** Skips RoB + Analysis, PRISMA programmatic

## CRITICAL RULES
1. ALL modes use full text for screening/extraction (never abstract-only)
2. **PRISMA is ALWAYS programmatic SVG in ALL modes - no exceptions**
3. Remove ALL LLM PRISMA code from codebase
- PRISMA is separate priority - programmatic generation preferred
- Backend-first approach, settings UI optional
- Unit tests only (no integration tests with real APIs for this feature)
